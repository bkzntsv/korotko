#!/bin/bash
SERVER="${1:-root@80.92.206.165}"

echo "üßπ –ù–∞—á–∏–Ω–∞—é –ê–ö–ö–£–†–ê–¢–ù–£–Æ –æ—á–∏—Å—Ç–∫—É –Ω–∞ $SERVER (—Ç–æ–ª—å–∫–æ ochemeto)..."

ssh -T $SERVER << EOF
# –í–∫–ª—é—á–∞–µ–º –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥
set -x

echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞..."
# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ compose, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –∂–∏–≤–∞
if [ -d "/opt/ochemeto" ]; then
    cd /opt/ochemeto
    # –ü—ã—Ç–∞–µ–º—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —á–µ—Ä–µ–∑ docker-compose
    if command -v docker-compose &> /dev/null; then
        docker-compose down 2>/dev/null || true
    else
        docker compose down 2>/dev/null || true
    fi
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –∏—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –∏–º–µ–Ω–µ–º, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º 'ochemeto' –∏–ª–∏ 'bot' –∏ —É–±–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏—Ö
# –í–ê–ñ–ù–û: grep -v grep –∏—Å–∫–ª—é—á–∞–µ—Ç —Å–∞–º—É –∫–æ–º–∞–Ω–¥—É –ø–æ–∏—Å–∫–∞
docker ps -a | grep -E "ochemeto|bot" | awk '{print \$1}' | xargs -r docker rm -f

echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–∑—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞..."
# –£–¥–∞–ª—è–µ–º dangling –æ–±—Ä–∞–∑—ã (–º—É—Å–æ—Ä –±–µ–∑ —Ç–µ–≥–æ–≤), —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker image prune -f

echo "üî™ –£–±–∏–≤–∞–µ–º –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Å–±–æ—Ä–∫–∏ (Gradle/Java)..."
# –£–±–∏–≤–∞–µ–º Java –ø—Ä–æ—Ü–µ—Å—Å—ã, –ø–æ—Ç—Ä–µ–±–ª—è—é—â–∏–µ –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏ (–æ–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–≤–∏—Å—à–∏–π Gradle Daemon)
# VPN –æ–±—ã—á–Ω–æ (WireGuard/OpenVPN) —ç—Ç–æ –Ω–µ Java, —Ç–∞–∫ —á—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ.
# –ù–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —É–±–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω—ã –æ—Ç root –∏ –ø–æ—Ö–æ–∂–∏ –Ω–∞ Gradle.
pkill -9 -f "gradle" || true
# –ï—Å–ª–∏ VPN –Ω–∞–ø–∏—Å–∞–Ω –Ω–µ –Ω–∞ Java, —Ç–æ —Å–ª–µ–¥—É—é—â–∞—è –∫–æ–º–∞–Ω–¥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞. 
# –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—Ç–µ—Å—å - –ª—É—á—à–µ –Ω–µ —É–±–∏–≤–∞—Ç—å java –≤—Å–ª–µ–ø—É—é, –Ω–æ Gradle –ø—Ä–æ—Ü–µ—Å—Å—ã —Ç–æ—á–Ω–æ –º–æ–∂–Ω–æ.
pkill -9 -f "kotlin-compile" || true

echo "üßπ –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∫–µ—à Gradle..."
rm -rf /opt/ochemeto
rm -rf ~/.gradle
rm -rf /root/.gradle

echo "‚ú® –ì–æ—Ç–æ–≤–æ! –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:"
echo "----------------------------------------"
echo "DISK (–î–∏—Å–∫):"
df -h / | grep /
echo "----------------------------------------"
echo "RAM (–ü–∞–º—è—Ç—å):"
free -h
echo "----------------------------------------"
EOF
